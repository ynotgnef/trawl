pipeline {
    agent { label 'medium' }

    parameters {
        name: 'GIT_BRANCH', string defaultValue: 'develop', description: '', trim: false
    }

    stages {
        stage('setup') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "${params.GIT_BRANCH}"]],
                    userRemoteConfigs: [[
                        credentialsId: 'github',
                        url: 'https://github.com/ynotgnef/trawl.git'
                    ]]
                ])
                sh '''#!/bin/bash -l
                    rvm use --create --install --binary 2.5.2
                    gem install bundler
                    rm Gemfile.lock || true
                    bundle install --jobs 3
                '''
            }
        }
        stage('test') {
            steps {
                sh '''#!/bin/bash -l
                    rspec
                '''
            }
        }
        stage('generate_position') {
            steps {
                sh '''#!/bin/bash -l
                    bundle exec ruby tickers.rb
                '''
            }
        }
        stage('update_position_to_app') {
            steps {
                echo 'update_position_to_app'
            }
        }
        stage('wait_for_approval') {
            steps {
                echo 'wait_for_approval'
            }
        }
        stage('execute_position') {
            steps {
                echo 'execute_position'
            }

        }
        stage('send_notification') {
            steps {
                echo 'notification'
            }
        }

    }
}